# Физические модели и предпосылки

## 1. Геометрия и сетка

- Прямоугольная декартова сетка с размерами `Nx × Ny × Nz`. Ячейки идентичны в пределах уровня, размеры задаются в конфигурации (`grid_size`).
- Координатная система правосторонняя, ось `z` направлена вверх. Вертикальные связи учитывают гравитацию через коэффициенты плотности.
- Пористость `φ` задаётся на ячеек уровне, может быть константой или распределением (в текущих конфиг-файлах — однородная).

## 2. Флюиды

### 2.1 Фазы

Симулятор поддерживает три подвижные фазы: нефть (o), вода (w), газ (g). Величины, хранимые по фазам:

- Давление `p`
- Насыщенности `S_w`, `S_g`, `S_o = 1 - S_w - S_g`
- Фазовые вязкости `μ_α(p)` и объёмные коэффициенты `B_α(p)` (читаются из PVT-таблиц)
- Плотности `ρ_α(p)` (учитывают сжимаемость)

### 2.2 PVT и сжимаемость

PVT-данные задаются в `configs/pvt/*.json`. В текущей реализации:

- Вязкости и объёмные коэффициенты — кусочно-линейные функции давления.
- Сжимаемость нефти/воды порядка 10⁻⁵ 1/МПа, газа — 10⁻³ 1/МПа.
- Плотность нефти и воды вычисляется по экспоненциальной коррекции:  
  `ρ(p) = ρ_ref * exp[c_α (p - p_ref)]`.

## 3. Относительные фазовые проницаемости

- Модель Stone II для 3-фазных расчётов.
- Параметры (`nw`, `no`, `sw_cr`, `so_r`) задаются в конфиге.
- При отсутствии газа симулятор автоматически переключается на 2-фазную версию кривых.

## 4. Капиллярное давление

- По умолчанию отключено (`pc_scale = 0`), но поддерживается степенная зависимость:  
  `p_cow(S_w) = pc_scale * (S_w - S_wc)^(-λ)`.
- Капиллярное давление вводится в уравнения потока через разность давления фаз.

## 5. Скважины

### 5.1 Геометрия

- Линейные источники/стоки, пронизанные через жёстко заданную ячейку `(i, j, k)`.
- Радиус скважины `r_w` учитывается в productivity index.

### 5.2 Управление

- **Rate control** — фиксированный поверхностный дебит (`surface_phase ∈ {oil, gas, liquid}`).
- **BHP control** (зарезервировано) — поддержка забойного давления (в разработке).

### 5.3 Расчёт дебита

Используется модифицированная формула Пайбека:

$$
q_α = \text{PI} \cdot \frac{k_{r,α}}{μ_α B_α} (p_\text{bhp} - p_\text{cell}),
$$

где коэффициент продуктивности `PI` учитывает радиус скважины, толщину пласта и скин-фактор (по умолчанию 0).

### 5.4 Перевод в поверхностные единицы

Потоки на выходе нормируются на объёмные коэффициенты для указанной фазовой смеси.

## 6. Гравитация

- Учитывается в балансах насыщенностей через `ρ_α g`.
- Градиент давления между ячейками дополняется гравитационной поправкой `ρ_α g Δz`.

## 7. Внешние воздействия

- **Инициализация** — равномерное давление и насыщенности (задаются в `fluid`).
- **Граничные условия** — во внутренних расчётах используются периодические/неявные условия (на практике сетка достаточно большая, чтобы границы не влияли). Возможна фиксация давления через анкерные узлы в AMG (см. `ClassicalAMG._apply_reference_fix`).

## 8. Проверка балансов

- Все тесты в `tests/test_component_balance_rv.py` и `tests/test_impes_3phase.py` проверяют, что массовый баланс выполнен с точностью до машинного эпсилона.
- Пример: при отключённых скважинах суммарная насыщенность остаётся единицей с точностью 10⁻¹².

## 9. Масштаб ограничений

- Текущие кейсы сфокусированы на слабо неоднородных пластах. Для высококонтрастных сред (отношение k_h/k_v > 10³) требуется дополнительная настройка AMG-параметров (см. [Производительность](PERFORMANCE.md)).

## 10. Направления развития

- Поддержка многокомпонентных средств (растворённый газ, полимерные потоки).
- Расширение библиотеки относительных проницаемостей.
- Режим полностью имплицитной схемы на базе JFNK с использованием того же AMG-предобуславливателя.

