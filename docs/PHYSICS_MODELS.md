# Физические модели и предпосылки

Этот раздел рассчитан на инженеров и разработчиков, которые только начинают знакомство с нефтяной тематикой. Ниже описано, **что именно симулирует код**, какие упрощения приняты и как всё это отражено в конфигурационных файлах.

---

## 1. Основы нефтяной инженерии

### 1.1 Что такое резервуар?

Резервуаром называем объём горных пород, пронизанный поровыми каналами. В них находится смесь нефти, воды и газа. Модель описывает:

- **пористость** $\phi$ — доля пористого пространства в объёме породы;
- **проницаемость** `k` — насколько легко жидкости проходят через поры (мД — миллидарси);
- **толщину** и **площадь** пласта.

В симуляторе резервуар разбивается на регулярную прямоугольную сетку (`Nx × Ny × Nz`), каждая ячейка хранит свои параметры.

### 1.2 Фазы и насыщенности

Внутри каждой ячейки находятся три фазы:

- нефть (`o`),
- вода (`w`),
- газ (`g`).

Насыщенности (доли по объёму):

$$
S_w + S_g + S_o = 1.
$$

Если в конфигурации указаны только нефть и вода, газовая фаза автоматически принимает насыщенность ноль.

### 1.3 Давление

Давление `p` считается единым для ячейки (давление воды), а давления нефти и газа отличаются на величину капиллярного давления. Давление измеряется в мегапаскалях (МПа).

---

## 2. Геометрия и сетка

### 2.1 Базовые параметры

- `reservoir.dimensions = [Nx, Ny, Nz]` — количество ячеек вдоль каждой оси.
- `reservoir.grid_size = [Δx, Δy, Δz]` — **средний** шаг (м) по каждой оси. Этот массив по‑прежнему обязателен: он используется как значение «по умолчанию» и для обратной совместимости со старыми конфигами.
- Ось `z` направлена вверх, поэтому разности высот между слоями рассчитываются автоматически.
- Гравитация учтена всегда; тяжёлые фазы стремятся вниз, лёгкие — вверх.

### 2.2 Расширенный блок `grid`

Чтобы задать неравномерную сетку, локальные LGR или приближённые corner‑point страты, используйте опциональный блок `reservoir.grid`:

```json
"reservoir": {
  "dimensions": [6, 6, 4],
  "grid_size": [20.0, 20.0, 5.0],
  "grid": {
    "dx": [12.0, 8.0, 10.0, 25.0, 25.0, 35.0],
    "y_nodes": [0, 15, 30, 38, 55, 80, 110],
    "dz": [3.0, 3.0, 4.0, 6.0]
  }
}
```

- `dx`, `dy`, `dz` — массивы длиной `Nx`, `Ny`, `Nz` соответственно с шагом по каждой ячейке.
- `x_nodes`, `y_nodes`, `z_nodes` — координаты узлов (должно быть `N+1` значений). Симулятор автоматически вычислит разности между соседними узлами.
- В одном направлении можно задать либо массив шагов, либо массив узлов. Если блок `grid` отсутствует, используются усреднённые значения из `grid_size`.
- Все значения интерпретируются в метрах. Для corner‑point/ступенчатых сеток достаточно задать «ступеньки» по соответствующей оси.

При загрузке симулятор вычисляет:

- ортогональные расстояния между центрами ячеек (`dx_vector`, `dy_vector`, `dz_vector`);
- расстояния между центрами соседних ячеек (`dx_face`, `dy_face`, `dz_face`) — именно они участвуют в расчёте проводимостей;
- точное значение объёма каждой ячейки (`cell_volume`) и порового объёма (`porous_volume`), что гарантирует корректный баланс масс.

> ⚠️ **Ограничение:** fully implicit (FI) сборка Якобиана в текущей реализации поддерживает только равномерные сетки. Для динамической равномерности проверяется флаг `reservoir.is_uniform_grid`.

---

## 3. Свойства пород

### 3.1 Пористость

- `reservoir.porosity` может быть:
  - скаляром (одно значение для всех ячеек),
  - массивом `Nx × Ny × Nz`,
  - путём к файлу `.npy`/`.npz` с трёхмерным массивом — удобно, если поля генерируются оффлайн.

### 3.2 Проницаемость

- `permeability` — горизонтальная проницаемость (мД).
- `k_vertical_fraction` — коэффициент, которым умножается горизонтальное значение, чтобы получить вертикальную проницаемость ($k_v = k_h \times k_{\text{vertical\_fraction}}$).
- При указании массива/файла допускается любое положительное значение; конвертация в СИ выполняется автоматически.

### 3.3 Стохастические поля (опционально)

Для быстрого прототипирования неоднородностей доступен блок `reservoir.stochastic`. Он позволяет сгенерировать поля пористости и/или проницаемости прямо при запуске:

```json
"reservoir": {
  "...": "...",
  "stochastic": {
    "seed": 123,
    "porosity": {
      "mean": 0.22,
      "std": 0.03,
      "corr_length": 1.5,
      "distribution": "normal",
      "min": 0.05,
      "max": 0.35
    },
    "permeability": {
      "mean": 120.0,
      "std": 30.0,
      "corr_length": 2.0,
      "distribution": "lognormal",
      "log_std": 0.45,
      "k_vertical_fraction": 0.12,
      "min_md": 1.0,
      "max_md": 3000.0
    }
  }
}
```

- `seed` (глобальный) фиксирует генерацию для воспроизводимости. Для разных полей используются последовательные значения (`seed`, `seed+1`, …).
- `corr_length` задаёт корреляционный радиус (в ячейках). При наличии SciPy применяется `gaussian_filter`; без него используется итеративное усреднение.
- `distribution`: `normal` (по умолчанию) или `lognormal`. Для логнормального закона можно задать `log_mean`/`log_std`.
- `min`/`max` (или `min_md`/`max_md` для проницаемости в мД) ограничивают диапазон значений.
- Вертикальная проницаемость берётся из горизонтальной и умножается на `k_vertical_fraction` внутри блока `permeability`. Если параметр опущен, используется общий `reservoir.k_vertical_fraction`.

> Генерируемые поля записываются в тензоры; они доступны через `reservoir.porosity`, `reservoir.permeability_x` и т.д. и также участвуют в расчёте поровых объёмов.

---

## 4. Свойства флюидов (PVT)

### 4.1 Что такое PVT?

PVT-таблицы описывают, как меняются свойства фаз в зависимости от давления:

- вязкость $\mu_\alpha(p)$, Па·с или мПа·с;
- объёмный коэффициент $B_\alpha(p)$ — сколько объёма занимает фаза на поверхности по сравнению с пластовыми условиями;
- плотность $\rho_\alpha(p)$.

В файлах `configs/pvt/*.json` свойства заданы в табличном виде. Симулятор интерполирует значения линейно.

### 4.2 Сжимаемость

Зависимость плотности от давления записана как экспонента:

$$
\rho(p) = \rho_{\text{ref}} \cdot e^{c_\alpha (p - p_{\text{ref}})}.
$$

Типичные коэффициенты:

- нефть, вода: 10⁻⁵ 1/МПа (почти несжимаемы),
- газ: 10⁻³ 1/МПа (намного сжимаемее).

---

## 5. Относительные проницаемости

### 5.1 Зачем они нужны

Когда в ячейке присутствуют сразу несколько фаз, каждая занимает свою часть порового пространства и мешает остальным течь. Это учитывается функциями относительной проницаемости $k_{r,\alpha}(S)$, которые уменьшают эффективную проницаемость для каждой фазы.

### 5.2 Используемая модель

По умолчанию — Stone II, классический вариант для трёх фаз. Она:

- гарантирует, что сумма фазовых потоков корректна;
- корректно обнуляет проницаемость при остаточных насыщенностях ($S_{w,\text{cr}}$, $S_{o,\text{r}}$);
- автоматически сводится к двум фазам, если газ отсутствует (или наоборот).

Параметры модели задаются в `fluid.relative_permeability` и включают функции $k_{r,\alpha}(S)$.

---

## 6. Капиллярное давление и поверхность раздела

- Капиллярка описывает разницу давлений между фазами из-за поверхностного натяжения в порах.
- В большинстве тестовых конфигураций `pc_scale = 0`, т.е. эффект выключен — это упрощает задачу и стабилизирует вычисления.
- При необходимости можно задать степенную зависимость `p_c(S)`; она автоматически включится в расчёт потоков.
- Отдельный блок `fluid.capillary_pressure_og` управляет нефть–газовой кривой (аналогично `pc_scale` и `pc_exponent`).
- Для исходно табличных моделей (SWOF/SGOF) значения Pc и его производные берутся непосредственно из таблиц.

### 6.1 Управление схемой апстриминга

В IMPES добавлен переключатель `simulation.use_capillary_potentials`:

- `false` (значение по умолчанию) — апстрим выбирается по чистому перепаду давлений, а капиллярные поправки учитываются только как отдельные градиенты для газа. Это максимально совместимо со старыми конфигурациями и устойчиво для грубых сеток.
- `true` — перенос выполняется по **полным потенциалам** (давление ± $p_c$ ± $ρgΔz$) для воды и газа. Рекомендуется включать, если вы явно задаёте ненулевые Pc или используете табличные SWOF/SGOF.

```json
"simulation": {
  "solver_type": "impes",
  "time_step_days": 0.5,
  "use_capillary_potentials": true,
  "max_substeps": 20
}
```

Под капотом:

- фазовые мобильности апстримятся по знаку полной разности потенциалов;
- вертикальные потоки автоматически учитывают $Δz$ между центрами ячеек;
- saturations дополнительно ограничиваются, чтобы не выходить за `sw_cr`, `so_r` и `sg_cr` даже при малых `sw_up`.

> При включении `use_capillary_potentials` убедитесь, что шаг по времени и `max_substeps` достаточно малы: фронты Pc становятся более резкими.

---

## 7. Скважины — как мы управляем пластом

### 7.1 Геометрия

Скважина привязана к конкретной ячейке `(i, j, k)`, считается вертикальной. Радиус `radius` участвует в формуле продуктивности.

### 7.2 Режимы работы

- **Rate control** — мы задаём дебит (объём на поверхности). Симулятор подбирает давление в ячейке, чтобы обеспечить указанный поток.
- **BHP control** (в разработке) — наоборот, фиксируем забойное давление, а дебит считается автоматически.

### 7.3 Расчёт дебитов

Используется модифицированная формула Пайбека:

$$
q_\alpha = \text{PI} \cdot \frac{k_{r,\alpha}}{\mu_\alpha B_\alpha} (p_{\text{bhp}} - p_{\text{cell}}),
$$

где `PI` — продуктивность (зависит от `k`, радиуса, толщины и скин-фактора). Если `p_\text{bhp}` не задан, он вычисляется из условия на дебит.

### 7.4 Перевод на поверхность

Любой расчётный пластовый поток переводится в поверхностный объём с учётом объёмного коэффициента $B_\alpha$.

---

## 8. Гравитация

Уравнение потока учитывает поправку $\rho_\alpha g \Delta z$. Это значит:

- тяжёлые фазы (вода, нефть) стремятся вниз;
- газ поднимается вверх;
- наклон пласта здесь не моделируется (сетка горизонтальная), но разница высот между слоями ($\Delta z$) учитывается.

---

## 9. Инициализация и граничные условия

- Начальные давления и насыщенности задаются в блоке `fluid`.
- Границы моделируются как закрытые (no-flow): поток через внешние ячейки отсутствует. Чтобы фиксировать давление, можно задать специальную «опорную» ячейку (делается в AMG через `_apply_reference_fix`).

---

## 10. Контроль балансов

Тесты `tests/test_component_balance_rv.py` и `tests/test_impes_3phase.py` проверяют:

- сохранение массы при отсутствии скважин;
- корректный учёт притоков/оттоков;
- отсутствие отрицательных насыщенностей и значений > 1.

---

## 11. Масштаб применимости

Текущие конфиги ориентированы на:

- умеренно неоднородные пласты (контраст проницаемости до 10²–10³),
- умеренные капиллярные эффекты (или их отсутствие),
- крупные сетки до 1 млн ячеек на одной GPU.

Если нужно моделировать чрезвычайно неоднородные среды, необходимо:

- детальнее настроить AMG (см. [Производительность](PERFORMANCE.md));
- расширить базис near-nullspace;
- возможно, уточнить модели относительных проницаемостей.

---

## 12. Что дальше?

В планах:

- расширять библиотеку PVT (многокомпонентные смеси, термальные эффекты, полимер/ПАВ);
- подключать расширенные модели скважин (MSW, surface-network, gas-lift);
- реализовать полностью имплицитную схему (JFNK) с учётом тех же физических моделей.

Если вы планируете расширять физическую часть, используйте этот документ как отправную точку: добавляйте новые блоки (например, «Тепловые эффекты», «Химические реакции») и обновляйте глоссарий.

