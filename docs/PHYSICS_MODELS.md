# Физические модели и предпосылки

Этот раздел рассчитан на инженеров и разработчиков, которые только начинают знакомство с нефтяной тематикой. Ниже описано, **что именно симулирует код**, какие упрощения приняты и как всё это отражено в конфигурационных файлах.

---

## 1. Основы нефтяной инженерии

### 1.1 Что такое резервуар?

Резервуаром называем объём горных пород, пронизанный поровыми каналами. В них находится смесь нефти, воды и газа. Модель описывает:

- **пористость** `φ` — доля пористого пространства в объёме породы;
- **проницаемость** `k` — насколько легко жидкости проходят через поры (мД — миллидарси);
- **толщину** и **площадь** пласта.

В симуляторе резервуар разбивается на регулярную прямоугольную сетку (`Nx × Ny × Nz`), каждая ячейка хранит свои параметры.

### 1.2 Фазы и насыщенности

Внутри каждой ячейки находятся три фазы:

- нефть (`o`),
- вода (`w`),
- газ (`g`).

Насыщенности (доли по объёму):

$$
S_w + S_g + S_o = 1.
$$

Если в конфигурации указаны только нефть и вода, газовая фаза автоматически принимает насыщенность ноль.

### 1.3 Давление

Давление `p` считается единым для ячейки (давление воды), а давления нефти и газа отличаются на величину капиллярного давления. Давление измеряется в мегапаскалях (МПа).

---

## 2. Геометрия и сетка

- Сетка всегда декартова. Параметры `dimensions` и `grid_size` задают число ячеек и размер каждой ячейки.
- Ось `z` направлена вверх, высоты центров ячеек вычисляются автоматически.
- Гравитация включена всегда; плотные фазы стремятся вниз, лёгкие — наверх.

---

## 3. Свойства пород

### 3.1 Пористость

Хранится в параметре `reservoir.porosity`. В текущих конфигурациях она постоянна, но при необходимости можно задать массив значений.

### 3.2 Проницаемость

- `permeability` — горизонтальная проницаемость (мД).
- `k_vertical_fraction` — коэффициент, которым умножается горизонтальное значение, чтобы получить вертикальную проницаемость (`k_v = k_h × k_vertical_fraction`).

---

## 4. Свойства флюидов (PVT)

### 4.1 Что такое PVT?

PVT-таблицы описывают, как меняются свойства фаз в зависимости от давления:

- вязкость `μ_α(p)`, Па·с или мПа·с;
- объёмный коэффициент `B_α(p)` — сколько объёма занимает фаза на поверхности по сравнению с пластовыми условиями;
- плотность `ρ_α(p)`.

В файлах `configs/pvt/*.json` свойства заданы в табличном виде. Симулятор интерполирует значения линейно.

### 4.2 Сжимаемость

Зависимость плотности от давления записана как экспонента:

$$
ρ(p) = ρ_\text{ref} \cdot e^{c_α (p - p_\text{ref})}.
$$

Типичные коэффициенты:

- нефть, вода: 10⁻⁵ 1/МПа (почти несжимаемы),
- газ: 10⁻³ 1/МПа (намного сжимаемее).

---

## 5. Относительные проницаемости

### 5.1 Зачем они нужны

Когда в ячейке присутствуют сразу несколько фаз, каждая занимает свою часть порового пространства и мешает остальным течь. Это учитывается функциями **относительной проницаемости** `k_{r,α}(S)`, которые уменьшают эффективную проницаемость для каждой фазы.

### 5.2 Используемая модель

По умолчанию — Stone II, классический вариант для трёх фаз. Она:

- гарантирует, что сумма фазовых потоков корректна;
- корректно обнуляет проницаемость при остаточных насыщенностях (`sw_cr`, `so_r`);
- автоматически сводится к двум фазам, если газ отсутствует (или наоборот).

Параметры модели задаются в `fluid.relative_permeability`.

---

## 6. Капиллярное давление и поверхность раздела

- Капиллярка описывает разницу давлений между фазами из-за поверхностного натяжения в порах.
- В большинстве тестовых конфигураций `pc_scale = 0`, т.е. эффект выключен — это упрощает задачу и стабилизирует вычисления.
- При необходимости можно задать степенную зависимость `p_c(S)`; она автоматически включится в расчёт потоков.

---

## 7. Скважины — как мы управляем пластом

### 7.1 Геометрия

Скважина привязана к конкретной ячейке `(i, j, k)`, считается вертикальной. Радиус `radius` участвует в формуле продуктивности.

### 7.2 Режимы работы

- **Rate control** — мы задаём дебит (объём на поверхности). Симулятор подбирает давление в ячейке, чтобы обеспечить указанный поток.
- **BHP control** (в разработке) — наоборот, фиксируем забойное давление, а дебит считается автоматически.

### 7.3 Расчёт дебитов

Используется модифицированная формула Пайбека:

$$
q_α = \text{PI} \cdot \frac{k_{r,α}}{μ_α B_α} (p_\text{bhp} - p_\text{cell}),
$$

где `PI` — продуктивность (зависит от `k`, радиуса, толщины и скин-фактора). Если `p_\text{bhp}` не задан, он вычисляется из условия на дебит.

### 7.4 Перевод на поверхность

Любой расчётный пластовый поток переводится в поверхностный объём с учётом объёмного коэффициента `B_α`.

---

## 8. Гравитация

Уравнение потока учитывает поправку `ρ_α g Δz`. Это значит:

- тяжёлые фазы (вода, нефть) стремятся вниз;
- газ поднимается вверх;
- наклон пласта здесь не моделируется (сетка горизонтальная), но разница высот между слоями (`Δz`) учитывается.

---

## 9. Инициализация и граничные условия

- Начальные давления и насыщенности задаются в блоке `fluid`.
- Границы моделируются как закрытые (no-flow): поток через внешние ячейки отсутствует. Чтобы фиксировать давление, можно задать специальную «опорную» ячейку (делается в AMG через `_apply_reference_fix`).

---

## 10. Контроль балансов

Тесты `tests/test_component_balance_rv.py` и `tests/test_impes_3phase.py` проверяют:

- сохранение массы при отсутствии скважин;
- корректный учёт притоков/оттоков;
- отсутствие отрицательных насыщенностей и значений > 1.

---

## 11. Масштаб применимости

Текущие конфиги ориентированы на:

- умеренно неоднородные пласты (контраст проницаемости до 10²–10³),
- умеренные капиллярные эффекты (или их отсутствие),
- крупные сетки до 1 млн ячеек на одной GPU.

Если нужно моделировать чрезвычайно неоднородные среды, необходимо:

- детальнее настроить AMG (см. [Производительность](PERFORMANCE.md));
- расширить базис near-nullspace;
- возможно, уточнить модели относительных проницаемостей.

---

## 12. Что дальше?

В планах:

- добавить растворённый газ и полимерные добавки;
- расширить библиотеку относительных проницаемостей;
- реализовать полностью имплицитную схему (JFNK) с учётом тех же физических моделей.

Если вы планируете расширять физическую часть, используйте этот документ как отправную точку: добавляйте новые блоки (например, «Тепловые эффекты», «Химические реакции») и обновляйте глоссарий.

