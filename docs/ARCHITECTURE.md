# Архитектура проекта

## 1. Общая схема

```
configs/*.json  ──►  src/simulator/Simulation  ──►  AMG решатель давления
                                  │
                                  ├─► src/simulator/reservoir.py
                                  ├─► src/simulator/fluid.py
                                  └─► src/simulator/well.py
```

Основные компоненты:

1. **Конфигурационный слой** (`configs/*`): JSON-файлы со всеми параметрами симуляции.
2. **Модуль Reservoir** (`simulator/reservoir.py`): описывает сетку, проницаемость, пористость, гравитационные данные.
3. **Модуль Fluid** (`simulator/fluid.py`): PVT-таблицы, относительные проницаемости, капиллярные давления.
4. **WellManager** (`simulator/well.py`): управление скважинами, перевод дебитов, мониторинг.
5. **Simulator** (`simulator/simulation.py`): главный цикл IMPES.
6. **Solver** (`solver/`): AMG и линейные решатели.

## 2. Структура каталогов `src/`

- `solver/`
  - `classical_amg.py` — реализация AMG.
  - `pressure_amg.py` — интерфейс для симулятора, кэш и GMRES.
- `simulator/`
  - `simulation.py` — IMPES-алгоритм, адаптивный шаг, контроль ошибок.
  - `reservoir.py` — генерация сетки, трансмиссивити.
  - `fluid.py` — PVT, относительные проницаемости, капиллярка.
  - `well.py` — модели скважин и перевод дебитов.
  - `numerics.py` (если присутствует) — вспомогательные численные функции.
- `plotting/` — генерация графиков.
- `output/` — экспорт результатов.
- `utils.py` — вспомогательные функции (seed, таймеры).

## 3. Поток данных во время шага

1. `Simulator.run_step()` вызывает `_impes_step`.
2. `_impes_pressure_step` формирует линейную систему `A x = b`.
3. `amg_solve` (в `pressure_amg.py`) выполняет:
   - поиск кэша `ClassicalAMG`;
   - обновление матрицы (`update_matrix`) или построение новой иерархии;
   - запуск V-циклов до достижения `tol`.
4. Обновлённое давление передаётся обратно в симулятор.
5. На основании новых давлений вычисляются межячейковые флюксы и проводится явное обновление насыщенностей.
6. Скважины обновляют дебиты, результаты логируются.

## 4. Кэширование AMG

- Глобальный словарь `_AMG_CACHE` хранится в `pressure_amg.py`.
- Ключ включает размер матрицы и параметры AMG. Это позволяет переиспользовать структуру при неизменной сетке.
- `ClassicalAMG.update_matrix` заменяет значения в `A` и обновляет релаксацию, что снижает время шага до нескольких секунд.

## 5. Конфигурационные файлы

Структура (пример `mega_3phase_million.json`):

- `simulation`: настройки времени, шага, AMG-параметров, ограничений.
- `reservoir`: размеры сетки, пористость, проницаемость, анизотропия.
- `fluid`: стартовые насыщенности, PVT-путь, модель относительных проницаемостей.
- `wells`: массив словарей со скважинами, где задаются тип, координаты, режим, дебит/давление.

## 6. Логи и результаты

- Все промежуточные данные пишутся в `results/<timestamped_name>/`.
- Сохраняются графики, текстовые отчёты, npz-файлы полей.
- AMG-лог выводится в консоль; при необходимости можно перенаправить в файл.

## 7. Тесты

- `tests/test_amg_pressure_solver.py` — качество AMG.
- `tests/test_impes_3phase.py` — smoke-тест трёхфазного режима.
- `tests/test_component_balance_rv.py` — балансы компонентов.
- `pytest` запускается с `PYTHONPATH=src`.

## 8. Расширение проекта

- Добавление новых моделей (relperm, PVT) — реализовать в `Fluid`.
- Новые типы скважин — расширить `WellManager`.
- Другие предобуславливатели — добавить в `solver/` и подключить через параметры конфигурации.
- Планируемая интеграция JFNK: вынести давление в нелинейный решатель, используя существующий AMG как линейный предобуславливатель.

