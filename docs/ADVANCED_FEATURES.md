# Продвинутые возможности

## 1. Кэширование AMG-иерархии

- Автоматически активируется в `pressure_amg.py`.
- Ключ кеша учитывает размер матрицы и основные параметры AMG.
- Для задач с фиксированной сеткой и меняющимися коэффициентами достаточно первый раз построить иерархию, далее обновляется только матрица.

## 2. Обновление матрицы без перестройки

```python
amg.update_matrix(A_new, diag_scaling=True)
```

- Обновляет значения `A` и при необходимости пересчитывает параметры сглаживателя.
- Используется в `amg_solve` при повторном шаге.

## 3. Настройка near-nullspace

- Параметры `nullspace_dim`, `nullspace_blend`, `nullspace_reg` задаются при создании `ClassicalAMG`.
- Можно добавлять пользовательские векторы, если известны особенности пласта (например, наклонные градиенты).

## 4. Настройка сглаживателей

- По умолчанию Jacobi с демпфированием (auto-ω).
- Возможна замена на Gauss–Seidel (CPU) или Chebyshev (планируется).

## 5. Логирование и диагностика

- На каждом уровне выводятся:
  - `const_rel`, `grad_rel`, `row_err_max`.
  - Количество отрицательных весов (ожидается 0).
  - Время на coarsening, prolongation, RAP.
- При включённом DEBUG-режиме можно сохранять иерархию в NPZ для анализов.

## 6. Частичное отключение капиллярного давления

- Параметр `pc_scale` влияет на жёсткость системы. При необходимости можно задать разные масштабы для разных фаз.

## 7. Гибкое управление скважинами

- Поддерживаются профили дебита (через изменение `control_value` по шагам).
- В планах — добавление ограничений по давлению и автоматическое переключение режимов (rate/BHP).

## 8. Тестовый стенд

- `tests/test_impes_3phase.py` — автоматический дымовой тест.
- `tests/test_amg_pressure_solver.py` — регрессия качества AMG.
- `tests/test_component_balance_rv.py` — проверка балансов компонент.

## 9. Интеграция с RL/оптимизацией

- Модуль `src/rl_env.py` предоставляет среду для взаимодействия с агентами.
- Возможна симуляция нескольких эпизодов с разными конфигами без перестройки AMG, если сетка совпадает.

