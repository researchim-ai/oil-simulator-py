# Oil Simulator — Обзор и поток вычислений

Этот документ даёт высокоуровневое представление о том, как устроен симулятор, из каких модулей он состоит и как протекает вычисление от шага ко времени к шагу.

### Ключевые сущности
- **Сетка и пласт** (`src/simulator/reservoir.py`): размеры, шаги сетки, пористость, проницаемости, поровые объёмы.
- **Флюиды** (`src/simulator/fluid.py`): плотности/вязкости фаз, относительные проницаемости, (опционально) PVT‑таблицы (Bo/Bg/Bw, Rs/Rv).
- **Состояние** (`src/simulator/simulation.py`): поля давления `p` и насыщенностей (в расчёте — преобразованная переменная `y` для воды), wells.
- **Решатель Ньютона** (`src/solver/jfnk.py`): JFNK (Jacobian‑Free Newton‑Krylov) с FGMRES и CPR‑предобуславливателем.
- **CPR** (`src/solver/cpr.py`): двухступенчатый прескондиционер (давление → насыщенности).
- **Geo‑AMG** (`src/solver/geo_solver_v2.py`): решает давление на первом этапе CPR (V‑cycles).
- **Вывод/логи** (`src/simulator/simulation.py`): цветной терминал и структурные JSON‑логи (JSONL).

### Поток вычислений

```mermaid
flowchart TD
  A[Парсинг конфига, инициализация сетки/пласт/флюидов] --> B[Инициализация состояния x=(p,y)]
  B --> C[Основной цикл по шагам времени]
  C --> D[Сбор невязки F(x) в hat‑переменных]
  D --> E[Ньютон (JFNK):
           линейная подсистема J·δ = -F]
  E --> F[FGMRES + CPR
           Stage‑1: давление → Geo‑AMG
           Stage‑2: насыщенности → S‑сглаживание]
  F --> G[Line Search / Trust‑Region
           + физические ограничения]
  G --> H{Критерии сходимости Ньютона?}
  H -- нет --> D
  H -- да  --> I[Применение шага, расчёт балансов,
                 вывод/логирование]
  I --> J{Финиш по времени?}
  J -- нет --> C
  J -- да  --> K[Завершение]
```

### Применяемые методы
- **JFNK**: решает нелинейную систему без явной сборки Якоби; нужна только функция `F(x)` и операция `J·v` через конечные разности. Это обеспечивает масштабируемость и работу на GPU.
- **FGMRES**: гибкий GMRES для несамосогласованных предобуславливателей (CPR меняет оператор между итерациями).
- **CPR**: «связывает» давление и насыщенности. Сначала решаем «жёсткий» блок давления с помощью AMG (эллиптика), затем корректируем насыщенности более дешёвым операторами транспорта.
- **Geo‑AMG**: быстрый V‑cycle с row‑equilibration, регулярным коарсенингом (прибл. 2×2×2) и RAP‑проекцией; эффективен на больших 3D сетках.
- **Line Search / Trust‑Region**: стабилизируют Ньютона (Armijo + мягкий trust‑радиус), с соблюдением физических ограничений (ограничение по давлению и насыщенностям).

### Где смотреть детали
- Архитектура/модули: `docs/ARCHITECTURE.md` (существующий документ) и этот обзор.
- Подробная математика (уравнения, дискретизация, JFNK/CPR/AMG): `docs/NUMERICS.md`.
- Логи/метрики: раздел «Логирование и диагностика» в `docs/USER_GUIDE.md` (будет добавлен) и JSONL в `logs/json`.

### Ключевые инварианты качества
- Консервативность по объёму: vol err ~ 0% (подтверждается на шаге).
- Сходимость Ньютона за малое число итераций (обычно 2–5), ratio<1e‑2 на принятых шагах.
- Массовый баланс в кг: с PVT — строгий, без PVT — малое отклонение по определению (см. NUMERICS).


