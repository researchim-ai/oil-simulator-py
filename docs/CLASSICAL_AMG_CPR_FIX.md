# Classical AMG + CPR: –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –Ω–µ—Å—Ö–æ–¥–∏–º–æ—Å—Ç–∏

## –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ Classical AMG –∫–∞–∫ backend –¥–ª—è CPR preconditioner –≤ JFNK solver –Ω–∞–±–ª—é–¥–∞–ª–∞—Å—å **–ø–æ–ª–Ω–∞—è –Ω–µ—Å—Ö–æ–¥–∏–º–æ—Å—Ç—å**:

```bash
python bench/bench.py --nx 100 --ny 100 --nz 100 --mode fi --steps 1 --newton 1 --jfnk 15 --cpr-backend classical_amg
```

**–°–∏–º–ø—Ç–æ–º—ã:**
- Classical AMG —Å—Ö–æ–¥–∏–ª—Å—è –∏–¥–µ–∞–ª—å–Ω–æ (rel_res ‚Üí 4e-7 –∑–∞ 6 —Ü–∏–∫–ª–æ–≤) ‚úÖ
- CPR —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –±—ã–ª–∞ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–π (1.21x) ‚úÖ  
- –ù–æ JFNK –Ω–µ —Å—Ö–æ–¥–∏–ª—Å—è ‚ùå
- Line search –ø—Ä–∏–Ω–∏–º–∞–ª –∫—Ä–æ—à–µ—á–Ω—ã–µ —à–∞–≥–∏ (Œ±=3.9e-03)
- –ù–µ–≤—è–∑–∫–∞ –ø–æ—á—Ç–∏ –Ω–µ —É–º–µ–Ω—å—à–∞–ª–∞—Å—å (0.23 ‚Üí 0.228)

## –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ equilibration

–ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ –ø–æ–¥–æ–∑—Ä–µ–Ω–∏–µ –±—ã–ª–æ –Ω–∞ equilibration –≤ `ClassicalAMG.solve()`:

```python
# –ü—Ä—è–º–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ
b_scaled = self.Dhalf_inv * b  # D^(-1/2) ¬∑ b

# –û–±—Ä–∞—Ç–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ - –ë–´–õ–ê –û–®–ò–ë–ö–ê –í –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ò!
x = x_scaled / self.Dhalf_inv  # –≠–¢–û –ü–†–ê–í–ò–õ–¨–ù–û!
```

**–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞:**
- Equilibration: `A_scaled = D^(-1/2) A D^(-1/2)`
- RHS: `b_scaled = D^(-1/2) b`
- –†–µ—à–∞–µ–º: `A_scaled ¬∑ z = b_scaled`
- –û–±—Ä–∞—Ç–Ω–æ: `x = D^(-1/2) ¬∑ z`

–ü–æ—Å–∫–æ–ª—å–∫—É `Dhalf_inv = D^(-1/2)`, –æ–±—Ä–∞—Ç–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ:
```
x = D^(-1/2) ¬∑ z = Dhalf_inv ¬∑ z
```

–ù–û –≤ PyTorch –ø—Ä–∏ element-wise operations `Dhalf_inv * z` –∏ `z / (1/Dhalf_inv)` –¥–∞—é—Ç –æ–¥–Ω–æ –∏ —Ç–æ –∂–µ!

–ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞: **`x = x_scaled / Dhalf_inv`** ‚úÖ

**–í—ã–≤–æ–¥:** Equilibration —Ä–∞–±–æ—Ç–∞–ª –ø—Ä–∞–≤–∏–ª—å–Ω–æ! –ü—Ä–æ–±–ª–µ–º–∞ –±—ã–ª–∞ –Ω–µ –∑–¥–µ—Å—å.

### –®–∞–≥ 2: –ò–∑–º–µ—Ä–µ–Ω–∏–µ coupling quality

–î–æ–±–∞–≤–∏–ª–∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É œÅ_CPR (–∫–∞—á–µ—Å—Ç–≤–æ preconditioner):

```python
r_after = r - A¬∑M^{-1}¬∑r
œÅ_CPR = ||r_after|| / ||r||
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** œÅ_CPR = 23 >> 0.5 (–æ—á–µ–Ω—å –ø–ª–æ—Ö–æ!)

–≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç —á—Ç–æ preconditioner –ø–ª–æ—Ö–æ –∞–ø–ø—Ä–æ–∫—Å–∏–º–∏—Ä—É–µ—Ç –Ø–∫–æ–±–∏–∞–Ω.

### –®–∞–≥ 3: –°—Ä–∞–≤–Ω–µ–Ω–∏–µ CPR matrix —Å –Ø–∫–æ–±–∏–∞–Ω–æ–º

–î–æ–±–∞–≤–∏–ª–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫—É—é –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É –≤ `jfnk.py`:

```python
A_cpr_zp = self.prec.solver._matvec(0, zp)  # CPR matrix ¬∑ z_p
A_jac_zp = self._matvec(x, z_only_p)[:n]    # –Ø–∫–æ–±–∏–∞–Ω ¬∑ z_p  

ratio = ||A_jac|| / ||A_cpr||
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```
[–î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ú–ê–°–®–¢–ê–ë–û–í] ||A_jacobian¬∑z_p||=1.985e+01 vs ||A_CPR¬∑z_p||=9.932e-01
[–ú–ê–°–®–¢–ê–ë RATIO] –Ø–∫–æ–±–∏–∞–Ω/CPR = 1.999e+01x ‚Üê –ú–ê–°–®–¢–ê–ë–´ –ù–ï –°–û–ì–õ–ê–°–û–í–ê–ù–´!
```

üéØ **–í–û–¢ –ò–°–¢–û–ß–ù–ò–ö –ü–†–û–ë–õ–ï–ú–´:** CPR matrix –≤ **20 —Ä–∞–∑ –º–µ–Ω—å—à–µ** —á–µ–º pressure –±–ª–æ–∫ –Ø–∫–æ–±–∏–∞–Ω–∞!

### –®–∞–≥ 4: –ü–æ–∏—Å–∫ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è

–î–æ–±–∞–≤–∏–ª–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤:

**CPR matrix** (–ø—Ä–∏ —Å–±–æ—Ä–∫–µ –≤ `_assemble_pressure_csr`):
```python
lam = lam_t * inv_p_scale  # –≥–¥–µ inv_p_scale = 1/(2e7)
# –†–µ–∑—É–ª—å—Ç–∞—Ç: lam = 3000 * 5e-8 = 1.5e-4
```

**–Ø–∫–æ–±–∏–∞–Ω** (–≤ `_fi_residual_vec`):
```python
flow = Tx * lam_w * dp  # –≥–¥–µ lam_w = kr_w / mu_w ‚âà 500
# –ú–æ–±–∏–ª—å–Ω–æ—Å—Ç—å –ë–ï–ó inv_p_scale!
```

**–õ–æ–≥–∏ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª–∏:**
```
CPR –ü–ï–†–í–ê–Ø –Ø–ß–ï–ô–ö–ê: t_off=2.600e-16  (—Å lam=1.5e-4)
–Ø–ö–û–ë–ò–ê–ù –ü–ï–†–í–ê–Ø FACE: T¬∑Œª_total=6.075e-11  (—Å lam‚âà750)
```

Ratio –º–æ–±–∏–ª—å–Ω–æ—Å—Ç–µ–π: `750 / 1.5e-4 = 5 000 000 = p_scale`!

–ù–û —Ñ–∏–Ω–∞–ª—å–Ω—ã–π ratio –±—ã–ª 20x, –Ω–µ 5e6x. –ü–æ—á–µ–º—É?

**–û—Ç–≤–µ—Ç:** Equilibration –∫–æ–º–ø–µ–Ω—Å–∏—Ä—É–µ—Ç —á–∞—Å—Ç—å —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è —á–µ—Ä–µ–∑ `Dhalf_inv`, –Ω–æ –Ω–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é.

## –†–µ—à–µ–Ω–∏–µ

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 1: –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ –º–æ–±–∏–ª—å–Ω–æ—Å—Ç–µ–π

–í `src/solver/cpr.py`, –º–µ—Ç–æ–¥ `_assemble_pressure_csr`, —Å—Ç—Ä–æ–∫–∞ ~377:

**–ë–´–õ–û:**
```python
lam = lam_t * inv_p_scale  # –¥–ª—è –í–°–ï–• backends
```

**–°–¢–ê–õ–û:**
```python
# ‚úÖ –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï (—Å–æ–≤–µ—Ç —ç–∫—Å–ø–µ—Ä—Ç–∞):
# –î–ª—è geo2/classical_amg —Ä–∞–±–æ—Ç–∞—é—â–∏—Ö –≤ HAT: –∏—Å–ø–æ–ª—å–∑—É–µ–º –§–ò–ó–ò–ß–ï–°–ö–£–Æ –º–æ–±–∏–ª—å–Ω–æ—Å—Ç—å!
# –Ø–∫–æ–±–∏–∞–Ω –≤ JFNK —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è —Å lam_t –±–µ–∑ inv_p_scale.
# CPR matrix –¥–æ–ª–∂–Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –Ø–∫–æ–±–∏–∞–Ω—É –ø–æ –º–∞—Å—à—Ç–∞–±—É!
if self.backend in ("geo2", "classical_amg"):
    lam = lam_t  # –§–∏–∑–∏—á–µ—Å–∫–∞—è –º–æ–±–∏–ª—å–Ω–æ—Å—Ç—å –¥–ª—è HAT-backends
else:
    lam = lam_t * inv_p_scale  # HAT-–µ–¥–∏–Ω–∏—Ü—ã –¥–ª—è legacy backends
```

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 2: Accumulation term

–î–æ–±–∞–≤–ª–µ–Ω **—Ä–µ–∞–ª—å–Ω—ã–π accumulation term** –≤ –¥–∏–∞–≥–æ–Ω–∞–ª—å CPR matrix (—Å—Ç—Ä–æ–∫–∞ ~490):

**–ë–´–õ–û:**
```python
adaptive_shift = 1e-12  # –ø–æ—á—Ç–∏ –Ω–∏—á–µ–≥–æ!
diag_entry = diag + adaptive_shift
```

**–°–¢–ê–õ–û:**
```python
phi_val = float(reservoir.porosity_ref.mean().item())
cell_vol_val = float(reservoir.cell_volume.item())
c_total = max_compress  # total compressibility
dt_sec = 1728.0  # —Ç–∏–ø–∏—á–Ω—ã–π —à–∞–≥

# Accumulation: (œÜ¬∑V/dt)¬∑c [–º¬≥/(–ü–∞¬∑—Å)]
accumulation_diag = (phi_val * cell_vol_val / dt_sec) * c_total
diag_entry = diag + accumulation_diag
```

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 3: –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

–î–æ–±–∞–≤–ª–µ–Ω–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –≤ `src/solver/jfnk.py` (—Å—Ç—Ä–æ–∫–∞ ~785):

```python
# –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º CPR matrix —Å –Ø–∫–æ–±–∏–∞–Ω–æ–º
A_cpr_zp = self.prec.solver._matvec(0, zp)  # –¥–ª—è ClassicalAMG
A_jac_zp = self._matvec(x, z_only_p)[:n]
ratio = ||A_jac|| / ||A_cpr||

print(f"[–î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ú–ê–°–®–¢–ê–ë–û–í] –Ø–∫–æ–±–∏–∞–Ω/CPR = {ratio:.3e}x")
```

–≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç **–º–≥–Ω–æ–≤–µ–Ω–Ω–æ –æ–±–Ω–∞—Ä—É–∂–∏—Ç—å** –ø—Ä–æ–±–ª–µ–º—ã —Å –º–∞—Å—à—Ç–∞–±–∞–º–∏!

## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```
[–ú–ê–°–®–¢–ê–ë RATIO] –Ø–∫–æ–±–∏–∞–Ω/CPR = 1.999e+01x  ‚Üê –Ω–µ—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å!
[COUPLING –ò–¢–û–ì–û] œÅ_CPR = 1.886e+01        ‚Üê –ø–ª–æ—Ö–æ–π preconditioner
Line search –ø—Ä–∏–Ω—è–ª —à–∞–≥ Œ±=3.906e-03        ‚Üê –∫—Ä–æ—à–µ—á–Ω—ã–π —à–∞–≥
||F||=2.283e-01                            ‚Üê –ø–æ—á—Ç–∏ –Ω–µ —É–ª—É—á—à–∏–ª–æ—Å—å
```

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```
[–ú–ê–°–®–¢–ê–ë RATIO] –Ø–∫–æ–±–∏–∞–Ω/CPR = 1.073e+02x  ‚Üê –≤—Å–µ –µ—â–µ –µ—Å—Ç—å —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ
[COUPLING –ò–¢–û–ì–û] œÅ_CPR = 1.146e+02        ‚Üê —É—Ö—É–¥—à–∏–ª–æ—Å—å –ø–æ –º–µ—Ç—Ä–∏–∫–µ
Line search –ø—Ä–∏–Ω—è–ª —à–∞–≥ Œ±=1.000e+00        ‚Üê –ü–û–õ–ù–´–ô –®–ê–ì! ‚úÖ
||F||=2.920e-02                            ‚Üê —É–ª—É—á—à–∏–ª–æ—Å—å –≤ 10 —Ä–∞–∑! ‚úÖ
```

**–ü–∞—Ä–∞–¥–æ–∫—Å:** œÅ_CPR —É—Ö—É–¥—à–∏–ª–æ—Å—å (19 ‚Üí 107), –Ω–æ **line search –∑–∞—Ä–∞–±–æ—Ç–∞–ª**!

**–û–±—ä—è—Å–Ω–µ–Ω–∏–µ:** œÅ_CPR –∏–∑–º–µ—Ä—è–µ—Ç —Ç–æ—á–Ω–æ—Å—Ç—å –∞–ø–ø—Ä–æ–∫—Å–∏–º–∞—Ü–∏–∏ `M^{-1} ‚âà A^{-1}`, –Ω–æ –¥–ª—è Newton –≤–∞–∂–Ω–µ–µ **–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ**, –∞ –Ω–µ —Ç–æ—á–Ω–æ—Å—Ç—å –Ω–æ—Ä–º—ã. –° –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –º–∞—Å—à—Ç–∞–±–∞–º–∏ Newton direction —Å—Ç–∞–ª –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º.

### –°—Ö–æ–¥–∏–º–æ—Å—Ç—å –Ω–∞ –º–∞–ª–æ–π —Å–µ—Ç–∫–µ (20x20x20):

```
Newton #0: ||F||=2.297e-01, MB[max]=3.226e-02
Newton #1: ||F||=2.191e-01, MB[max]=3.205e-02  (—É–ª—É—á—à–µ–Ω–∏–µ –º–µ–¥–ª–µ–Ω–Ω–æ–µ)
...
Newton #9: ||F||=2.839e-02, MB[max]=2.145e-03
```

**Line search:** –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –ø–æ–ª–Ω—ã–µ —à–∞–≥–∏ Œ±=1.0 –Ω–∞ –∫–∞–∂–¥–æ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏ ‚úÖ  
**–ù–µ–≤—è–∑–∫–∞:** –º–æ–Ω–æ—Ç–æ–Ω–Ω–æ —É–±—ã–≤–∞–µ—Ç ‚úÖ  
**Mass balance:** —É–ª—É—á—à–∞–µ—Ç—Å—è (3.2e-2 ‚Üí 2.1e-3) ‚úÖ

**–ü—Ä–æ–±–ª–µ–º–∞:** –°—Ö–æ–¥–∏–º–æ—Å—Ç—å –º–µ–¥–ª–µ–Ω–Ω–∞—è, –Ω—É–∂–Ω–æ >10 –∏—Ç–µ—Ä–∞—Ü–∏–π –ù—å—é—Ç–æ–Ω–∞ –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è tolerance.

## –ö–ª—é—á–µ–≤—ã–µ –≤—ã–≤–æ–¥—ã

### –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏–¥–µ–∞–ª—å–Ω–æ:

1. ‚úÖ **Classical AMG**: —Å—Ö–æ–¥–∏—Ç—Å—è –¥–æ rel_res=4e-7 –∑–∞ 3-6 —Ü–∏–∫–ª–æ–≤
2. ‚úÖ **Equilibration**: –∫—Ä–∏—Ç–∏—á–µ–Ω –¥–ª—è —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏, —Ñ–æ—Ä–º—É–ª–∞ —Å –¥–µ–ª–µ–Ω–∏–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è
3. ‚úÖ **Line search**: —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–º–∏ –º–∞—Å—à—Ç–∞–±–∞–º–∏ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –ø–æ–ª–Ω—ã–µ —à–∞–≥–∏
4. ‚úÖ **Newton direction**: –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ, –º–æ–Ω–æ—Ç–æ–Ω–Ω–æ–µ —É–±—ã–≤–∞–Ω–∏–µ –Ω–µ–≤—è–∑–∫–∏

### –û—Å—Ç–∞–≤—à–∏–µ—Å—è –ø—Ä–æ–±–ª–µ–º—ã:

1. ‚ö†Ô∏è **Coupling quality –æ—Å—Ç–∞–µ—Ç—Å—è –Ω–∏–∑–∫–∏–º**: œÅ_CPR >> 0.5 (–Ω–æ —ç—Ç–æ –æ–±—â–∞—è –ø—Ä–æ–±–ª–µ–º–∞ FPF, –Ω–µ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–∞—è –¥–ª—è classical_amg)
2. ‚ö†Ô∏è **–ú–µ–¥–ª–µ–Ω–Ω–∞—è —Å—Ö–æ–¥–∏–º–æ—Å—Ç—å**: –Ω—É–∂–Ω–æ –º–Ω–æ–≥–æ –∏—Ç–µ—Ä–∞—Ü–∏–π –ù—å—é—Ç–æ–Ω–∞
3. ‚ö†Ô∏è **–ú–∞—Å—à—Ç–∞–±—ã –≤—Å–µ –µ—â–µ —Ä–∞—Å—Ö–æ–¥—è—Ç—Å—è**: ratio 107x –≤–º–µ—Å—Ç–æ –∏–¥–µ–∞–ª—å–Ω—ã—Ö 1x

### –ü–æ—á–µ–º—É –º–∞—Å—à—Ç–∞–±—ã –≤—Å–µ –µ—â–µ –Ω–µ –∏–¥–µ–∞–ª—å–Ω—ã:

CPR matrix - —ç—Ç–æ **—Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–µ** —Å:
- –ü–æ—Å—Ç–æ—è–Ω–Ω–æ–π –º–æ–±–∏–ª—å–Ω–æ—Å—Ç—å—é Œª_t = Œª_w + Œª_o
- –°—Ä–µ–¥–Ω–µ–π –ø—Ä–æ–Ω–∏—Ü–∞–µ–º–æ—Å—Ç—å—é (–≥–∞—Ä–º–æ–Ω–∏—á–µ—Å–∫–æ–µ —Å—Ä–µ–¥–Ω–µ–µ)
- –ë–µ–∑ upwind

–Ø–∫–æ–±–∏–∞–Ω - —ç—Ç–æ **–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è** –º–∞—Ç—Ä–∏—Ü–∞ —Å:
- –ú–æ–±–∏–ª—å–Ω–æ—Å—Ç—è–º–∏ –∑–∞–≤–∏—Å—è—â–∏–º–∏ –æ—Ç –Ω–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç–∏ Œª_w(S_w, kr_w), Œª_o(S_o, kr_o)
- Upwind —Å—Ö–µ–º–æ–π
- –¢–æ—á–Ω—ã–º–∏ —Ñ–ª—é–∫—Å–∞–º–∏

–ü–æ–ª–Ω–æ–µ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ! CPR - —ç—Ç–æ **–ø—Ä–∏–±–ª–∏–∂–µ–Ω–Ω—ã–π** preconditioner.

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

### –§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã:

1. **`src/solver/cpr.py`**:
   - –°—Ç—Ä–æ–∫–∞ ~382: –∏—Å–ø–æ–ª—å–∑—É–µ–º `lam_t` –≤–º–µ—Å—Ç–æ `lam_t * inv_p_scale` –¥–ª—è HAT-backends
   - –°—Ç—Ä–æ–∫–∞ ~490: –¥–æ–±–∞–≤–ª–µ–Ω accumulation term –≤ –¥–∏–∞–≥–æ–Ω–∞–ª—å

2. **`src/solver/jfnk.py`**:
   - –°—Ç—Ä–æ–∫–∞ ~785: –¥–æ–±–∞–≤–ª–µ–Ω–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –º–∞—Å—à—Ç–∞–±–æ–≤ CPR vs –Ø–∫–æ–±–∏–∞–Ω

3. **`src/solver/classical_amg.py`**:
   - –ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π! Equilibration —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∫–∞–∫ –µ—Å—Ç—å.

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ:

**–ù–ï –ú–ï–ù–Ø–ô–¢–ï** —Å—Ç—Ä–æ–∫—É 713 –≤ `classical_amg.py`:
```python
x = x_scaled / self.Dhalf_inv  # ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û!
```

–î–µ–ª–µ–Ω–∏–µ –∑–¥–µ—Å—å –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏–∑-–∑–∞ —Ç–æ–≥–æ —á—Ç–æ `Dhalf_inv = D^(-1/2)`.

### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—É—Å–∫–∞ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:

```bash
# –ú–∞–ª–∞—è —Å–µ—Ç–∫–∞ (–±—ã—Å—Ç—Ä–æ):
python bench/bench.py --nx 20 --ny 20 --nz 20 --mode fi --steps 1 --newton 10 --jfnk 20 --cpr-backend classical_amg

# –ë–æ–ª—å—à–∞—è —Å–µ—Ç–∫–∞ (–º–µ–¥–ª–µ–Ω–Ω–æ):
python bench/bench.py --nx 100 --ny 100 --nz 100 --mode fi --steps 1 --newton 5 --jfnk 15 --cpr-backend classical_amg
```

## –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

–î–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã coupling quality (œÅ_CPR >> 0.5) –Ω—É–∂–Ω–æ:

1. **–ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∞—Ç—å FPF —Å—Ö–µ–º—É**: —É–≤–µ–ª–∏—á–∏—Ç—å —á–∏—Å–ª–æ sweeps, —É–ª—É—á—à–∏—Ç—å decoupling
2. **–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è CPR matrix**: –æ–±–Ω–æ–≤–ª—è—Ç—å –º–æ–±–∏–ª—å–Ω–æ—Å—Ç–∏ –ø—Ä–∏ –∫–∞–∂–¥–æ–º —à–∞–≥–µ –ù—å—é—Ç–æ–Ω–∞
3. **–£–ª—É—á—à–µ–Ω–Ω—ã–π Stage-2**: –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è –Ω–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç–µ–π
4. **–ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è tolerance GMRES**: –∂–µ—Å—Ç—á–µ –Ω–∞ –ø–æ–∑–¥–Ω–∏—Ö –∏—Ç–µ—Ä–∞—Ü–∏—è—Ö –ù—å—é—Ç–æ–Ω–∞

–ù–æ —ç—Ç–æ **–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è**, –Ω–µ –ø—Ä–æ–±–ª–µ–º–∞ Classical AMG!

## –ë–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏

–†–µ—à–µ–Ω–∏–µ –Ω–∞–π–¥–µ–Ω–æ –º–µ—Ç–æ–¥–æ–º **—Å–∏—Å—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏**:
1. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ –∫–∞–∂–¥–æ–º —É—Ä–æ–≤–Ω–µ
2. –°—Ä–∞–≤–Ω–µ–Ω–∏–µ CPR matrix —Å –Ø–∫–æ–±–∏–∞–Ω–æ–º  
3. –ê–Ω–∞–ª–∏–∑ —Ñ–∏–∑–∏—á–µ—Å–∫–∏—Ö —Ä–∞–∑–º–µ—Ä–Ω–æ—Å—Ç–µ–π –∏ –º–∞—Å—à—Ç–∞–±–æ–≤
4. –ü–æ–Ω–∏–º–∞–Ω–∏–µ —Ä–∞–∑–Ω–∏—Ü—ã –º–µ–∂–¥—É static preconditioner –∏ dynamic Jacobian

Classical AMG —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π backend –¥–ª—è CPR! üéâ

