# Дорожная карта: Путь к промышленному симулятору

Этот документ описывает план трансформации `oil-simulator-py` из исследовательского прототипа в инструмент промышленного класса (аналог Eclipse/tNavigator).

## Этап 1: Фундамент устойчивости (The Stability Foundation)
**Цель:** Гарантировать сходимость и сохранение масс на сложных задачах.

### 1.1. Переход на Fully Implicit (FIM) как стандарт
IMPES (текущий метод) имеет жесткие ограничения по шагу времени (CFL). Для реальных задач нужна полностью неявная схема.
* [ ] **Реализовать полный Якобиан для 3-х фаз:** (Нефть, Вода, Газ). Блок 3x3 для каждой ячейки.
* [ ] **Ньютоновский цикл:** Реализовать robust Newton-Raphson с отсечением шага (Appleyard chopping) для предотвращения нефизичных значений.
* [ ] **Линейный решатель для систем 3xN:** Текущий AMG работает со скалярным давлением. Нужно адаптировать его для блочных матриц (CPR-AMG — Constrained Pressure Residual) или подключить внешний мощный солвер (PETSc / Hypre через Python-биндинги).

### 1.2. Контроль материального баланса
* [ ] **Strict Mass Balance:** Внедрить строгую проверку сохранения массы на каждом шаге Ньютона. Ошибка баланса должна быть критерием сходимости, а не просто давления.

## Этап 2: Реальная геометрия (The Real World)
**Цель:** Загрузка геологических моделей из Petrel/RMS.

### 2.1. Поддержка Corner Point Geometry (CPG)
Сейчас сетка — это просто `dx, dy, dz`. Реальные пласты — это искаженные гексаэдры.
* [ ] **Парсер GRDECL:** Чтение ключевых слов `COORD`, `ZCORN`, `ACTNUM`.
* [ ] **Расчет трансмиссибильностей (TPFA) для CPG:** Это самая сложная геометрическая часть. Нужно считать площади контактов соседних неправильных гексаэдров.
* [ ] **Визуализация CPG:** Адаптация `view_gui.py` для отображения неструктурных сеток (Unstructured Grid в VTK).

### 2.2. Неактивные ячейки и разломы
* [ ] **ACTNUM:** Поддержка "дырок" в сетке (активные/неактивные ячейки).
* [ ] **Faults:** Поддержка непроницаемых барьеров и non-neighbor connections (NNC), когда ячейки соединяются через разлом.

## Этап 3: Промышленные скважины (The Operation)
**Цель:** Моделирование реальных режимов работы.

### 3.1. Расширенные контроли
* [ ] **BHP Limits:** Автоматическое переключение с контроля по дебиту (Rate Control) на контроль по забойному давлению (BHP), если давление падает ниже предела.
* [ ] **Group Control:** Ограничения на группу скважин (например, "общая добыча жидкости куста не более 5000 м3/сут").

### 3.2. Модель ствола (Wellbore)
* [ ] **VFP (Lift Tables):** Поддержка таблиц вертикального лифта для пересчета забойного давления в устьевое (THP).
* [ ] **Crossflow:** Учет перетока между слоями через ствол скважины при остановке.

## Этап 4: Производительность (The Speed)
**Цель:** Считать миллион ячеек за минуты, а не часы.

### 4.1. Backend Optimization
Текущий Python loop + PyTorch kernels имеет оверхед.
* [ ] **C++ Extensions:** Переписать сборку Якобиана и расчет свойств (RHS) на C++ (pybind11) или CUDA. Это ускорит расчет "физики" в 10-50 раз.
* [ ] **Sparse Matrix Assembly:** Сборка разреженной матрицы — узкое место. Нужно делать это напрямую в C++ структурах (CSR).

## Приоритетный план действий (Next Steps)

1. **Fully Implicit (FIM) Prototype:** Сделать прототип полностью неявного решателя хотя бы для 1D/2D, чтобы отладить Якобиан.
2. **GRDECL Reader:** Написать скрипт, который читает экспорт из Petrel и переводит его в наш формат (пока как "эквивалентный прямоугольный", потом честный).
3. **CPR Preconditioner:** Реализовать двухступенчатое предобуславливание (CPR) для нашего решателя. Это стандарт для нефтянки.

